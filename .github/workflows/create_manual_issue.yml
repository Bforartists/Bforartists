name: Create issue in manual when a PR is merged

on:
  pull_request:
    types: [closed]   # Runs just at closed pull requests (including Merge)

jobs:
  create_issue_on_merge:
    runs-on: ubuntu-latest
    # Only when an actual merge happened
    if: github.event.pull_request.merged == true

    permissions:
      contents: read          # For actions/checkout (In case you need code)
      issues: write           # So that we can create an issue

    steps:
      - name: Checkout source repo (bforartists/bforartists)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # optional, for the Gitâ€‘History

      - name: Create issue in manual repo
        env:
          GH_PAT_AUTO_ISSUE: ${{ secrets.GH_PAT_AUTO_ISSUE }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}" # the pull request number
          PR_TITLE="${{ github.event.pull_request.title }}" # the pull request title
          PR_DESCRIPTION="${{ github.event.pull_request.body }}" # the pull request description
          PR_URL="${{ github.event.pull_request.html_url }}" # the pull request url
          TARGET_REPO="bforartists/manual"

          TITLE="Merged PR #${PR_NUM} ${PR_TITLE}"
          # Clean up the body text to remove problematic characters
          BODY=$(printf '%s' "Pull request: #${PR_NUM} from the Bforartists repository.\nTitle: ${PR_TITLE}\nLink: ${PR_URL}\n\n## Description:\n${PR_DESCRIPTION}\n\nPlease review the changes and update the manual." | tr -d '\r' | sed 's/"/\\"/g')

          echo "Creating issue: ${TITLE}"

          # Use jq to create properly formatted JSON
          BODY_JSON=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{title: $title, body: $body}')
          
          # -v switch stands for verbose, and writes all errors. curl -s stands for silent, no error messages.
          curl -v \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT_AUTO_ISSUE}" \
            -X POST \
            -d "$BODY_JSON" \
            "https://api.github.com/repos/${TARGET_REPO}/issues"
