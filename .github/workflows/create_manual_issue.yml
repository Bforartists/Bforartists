name: Create issue in manual when a PR is merged

on:
  push:
    branches:
      - master

jobs:
  issue_on_merge:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'Merge pull request') &&
      contains(github.event.head_commit.message, '#')

    steps:
      - name: Checkout source repo (bforartists/bforartists)
        uses: actions/checkout@v4

      - name: Extract PR number from commit message
        id: prnum
        run: |
          MSG="${{ github.event.head_commit.message }}"
          if [[ "$MSG" =~ \#([0-9]+) ]]; then
            echo "pr_number=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "::error::Could not find PR number in commit message."
            exit 1
          fi

      - name: Create issue in manual repo
        env:
          GH_PAT_AUTO_ISSUE: ${{ secrets.GH_PAT_AUTO_ISSUE }}
        run: |
          PR_NUM="${{ steps.prnum.outputs.pr_number }}"
          TARGET_REPO="bforartists/manual"
          TITLE="Merged PR #$PR_NUM"

          BODY="Pull request #$PR_NUM was merged into \`master\` of **bforartists/bforartists**.

          Please review the changes and verify that they meet our quality standards."

          echo "Creating issue: $TITLE"

          RESPONSE=$(curl -s \
            -H "Authorization: token $GH_PAT_AUTO_ISSUE" \
            -X POST \
            -d "{\"title\":\"$TITLE\",\"body\":\"$BODY\"}" \
            https://api.github.com/repos/$TARGET_REPO/issues)

          if [ $? -ne 0 ]; then
            echo "::error::Failed to create issue"
            exit 1
          fi

          echo "Issue created successfully: $RESPONSE"
