name: Create issue in manual when a PR is merged

# --------------------------------------------------------------
# 1. Trigger on any push to the default branch (e.g. main or master)
# --------------------------------------------------------------
on:
  push:
    branches:
      - main          # change if your default branch has another name

jobs:
  issue_on_merge:
    runs-on: ubuntu-latest
    # Only run when the commit is a merge of a pullâ€‘request
    if: contains(github.event.head_commit.message, 'Merge pull request')

    steps:
      - name: Checkout source repo (bforartists/bforartists)
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Extract PR number from commit message
      # ------------------------------------------------------------
      - name: Extract PR number from commit message
        id: prnum
        run: |
          MSG="${{ github.event.head_commit.message }}"
          if [[ "$MSG" =~ \#([0-9]+) ]]; then
            echo "pr_number=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "::error::Could not find PR number in commit message."
            exit 1
          fi

      # ------------------------------------------------------------
      # 3. Create issue in the target repo (bforartists/manual)
      # ------------------------------------------------------------
      - name: Create issue in manual repo
        env:
          GH_PAT_AUTO_ISSUE: ${{ secrets.GH_PAT_AUTO_ISSUE }}   # PAT from secret
        run: |
          PR_NUM="${{ steps.prnum.outputs.pr_number }}"
          TARGET_REPO="bforartists/manual"    # target repository
          TITLE="Merged PR #$PR_NUM"
          BODY=$(cat <<EOF
          Pull request #$PR_NUM was merged into \`main\` of **bforartists/bforartists**.

          Please review the changes and verify that they meet our quality standards.
          EOF
          )

          echo "Creating issue: $TITLE"

          curl -s \
            -H "Authorization: token $GH_PAT_AUTO_ISSUE" \
            -X POST \
            -d "{\"title\":\"$TITLE\",\"body\":\"$BODY\"}" \
            https://api.github.com/repos/$TARGET_REPO/issues
