name: Create issue on merge

on:
  push:
    branches:
      - master          # change this to your main branch name if needed

jobs:
  create_issue:
    # Only run when a PR is merged (the `merged` flag exists in the event payload)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Create issue via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT_AUTO_ISSUE }}   # personal access token secret
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Build the issue title and body
          TITLE="Merge of PR #$PR_NUMBER"
          BODY=$(cat <<EOF
          ## Merge Details

          * **Pullâ€‘Request**: [#$PR_NUMBER](https://github.com/$REPO_OWNER/$REPO_NAME/pull/$PR_NUMBER)
          * **Commit**: [$COMMIT_SHA](https://github.com/$REPO_OWNER/$REPO_NAME/commit/$COMMIT_SHA)

          > This issue was automatically created because PR #$PR_NUMBER was merged into the main branch.
          EOF
          )

          # Create JSON payload for the API call
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{title: $title, body: $body}')

          # Call GitHub REST API to create the issue
          curl -sSL -X POST "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues" \
               -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github+json" \
               --data "$PAYLOAD"
